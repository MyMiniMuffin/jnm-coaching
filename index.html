<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>JNM Coaching</title>
    
    <!-- PWA: Meta Tags for Mobile -->
    <meta name="theme-color" content="#171717">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="JNM">
    <meta name="application-name" content="JNM Coaching">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#171717">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- FAVICON for browser tabs -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='160' fill='%23171717'/%3E%3Cpath d='M256 96c0 88.4 71.6 160 160 160-88.4 0-160 71.6-160 160 0-88.4-71.6-160-160-160 88.4 0 160-71.6 160-160z' fill='%23FAFAF9'/%3E%3C/svg%3E">
    
    <!-- Apple Touch Icons - PNG required for iOS -->
    <link rel="apple-touch-icon" href="/icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icon-192.png">

    <!-- Tailwind CSS with Typography Plugin -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'system-ui', 'sans-serif'],
                        display: ['Instrument Serif', 'Georgia', 'serif'],
                    },
                    colors: {
                        surface: {
                            50: '#FAFAF9',
                            100: '#F5F5F4',
                            200: '#E7E5E4',
                            300: '#D6D3D1',
                        },
                        ink: {
                            DEFAULT: '#171717',
                            muted: '#525252',
                            faint: '#A3A3A3',
                        },
                        accent: {
                            DEFAULT: '#171717',
                            hover: '#262626',
                        },
                        success: '#16A34A',
                        warning: '#CA8A04',
                        error: '#DC2626',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeIn: {
                            'from': { opacity: '0' },
                            'to': { opacity: '1' }
                        },
                        slideUp: {
                            'from': { opacity: '0', transform: 'translateY(16px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' }
                        },
                        scaleIn: {
                            'from': { opacity: '0', transform: 'scale(0.96)' },
                            'to': { opacity: '1', transform: 'scale(1)' }
                        }
                    },
                    typography: (theme) => ({
                        DEFAULT: {
                            css: {
                                color: theme('colors.ink.DEFAULT'),
                                a: { color: theme('colors.ink.DEFAULT'), textDecoration: 'underline' },
                                h1: { fontFamily: theme('fontFamily.display'), fontWeight: '400' },
                                h2: { fontFamily: theme('fontFamily.display'), fontWeight: '400' },
                                h3: { fontFamily: theme('fontFamily.display'), fontWeight: '400' },
                                strong: { fontWeight: '600' },
                            },
                        },
                    }),
                }
            }
        }
    </script>

    <!-- Marked Library -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- React Import Map -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1",
                "react-zoom-pan-pinch": "https://esm.sh/react-zoom-pan-pinch@3.4.4?external=react,react-dom"
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Outfit:wght@300;400;500;600;700&display=swap');

        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            overscroll-behavior-y: none;
            font-family: 'Outfit', system-ui, sans-serif;
            background-color: #FAFAF9;
            color: #171717;
            letter-spacing: -0.01em;
        }

        .font-display {
            font-family: 'Instrument Serif', Georgia, serif;
        }

        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-area-pt { padding-top: env(safe-area-inset-top); }
        
        input[type="checkbox"]:checked {
            background-color: #171717;
            border-color: #171717;
        }

        .glass-nav {
            background: rgba(250, 250, 249, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .prose p { margin-bottom: 1em; line-height: 1.7; }
        .prose h1 { font-size: 1.75em; margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose h2 { font-size: 1.375em; margin-top: 1.5em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; }
        .prose li { margin-bottom: 0.5em; }

        /* Subtle grain texture */
        .grain::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
        }

        /* Custom focus states */
        input:focus, textarea:focus, select:focus, button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px #171717;
        }

        /* Smooth number input */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body class="text-ink select-none antialiased">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useCallback, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Home, Utensils, Dumbbell, ClipboardCheck, Camera, Save, ChevronRight, ChevronLeft,
          TrendingUp, TrendingDown, Minus, User, Briefcase, LogOut, ArrowRight, Plus, 
          X, Trash2, Footprints, Edit2, Check, Moon, Zap, Scale, Loader2, AlertCircle, 
          Calendar, Pause, Play, Activity, Eye, ChevronDown
        } from 'lucide-react';
        
        import { TransformWrapper, TransformComponent } from 'react-zoom-pan-pinch';

        // --- CONFIG ---
        const APP_ICON = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='160' fill='%23171717'/%3E%3Cpath d='M256 96c0 88.4 71.6 160 160 160-88.4 0-160 71.6-160 160 0-88.4-71.6-160-160-160 88.4 0 160-71.6 160-160z' fill='%23FAFAF9'/%3E%3C/svg%3E";

        if (window.marked) {
            window.marked.setOptions({ breaks: true, gfm: true });
        }

        // --- KONFETTI SYSTEM ---
        const createConfetti = () => {
            const container = document.createElement('div');
            container.style.cssText = 'position:fixed;inset:0;pointer-events:none;z-index:9999;overflow:hidden';
            document.body.appendChild(container);

            const colors = ['#171717', '#525252', '#A3A3A3', '#16A34A', '#FAFAF9'];
            const shapes = ['circle', 'square'];
            
            for (let i = 0; i < 60; i++) {
                const confetti = document.createElement('div');
                const size = Math.random() * 10 + 6;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                const startX = Math.random() * window.innerWidth;
                const drift = (Math.random() - 0.5) * 200;
                
                confetti.style.cssText = `
                    position:absolute;
                    width:${size}px;
                    height:${size}px;
                    background:${color};
                    border-radius:${shape === 'circle' ? '50%' : '2px'};
                    left:${startX}px;
                    top:-20px;
                    opacity:1;
                    transform:rotate(${Math.random() * 360}deg);
                `;
                
                container.appendChild(confetti);
                
                const duration = Math.random() * 1500 + 2000;
                const delay = Math.random() * 300;
                
                confetti.animate([
                    { transform: `translateY(0) translateX(0) rotate(0deg)`, opacity: 1 },
                    { transform: `translateY(${window.innerHeight + 100}px) translateX(${drift}px) rotate(${Math.random() * 720}deg)`, opacity: 0 }
                ], {
                    duration,
                    delay,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
                    fill: 'forwards'
                });
            }

            setTimeout(() => container.remove(), 3500);
        };

        // --- SWIPE HOOK ---
        const useSwipe = (onSwipeLeft, onSwipeRight, options = {}) => {
            const { threshold = 50, enabled = true } = options;
            const touchStart = React.useRef(null);
            const touchEnd = React.useRef(null);

            const onTouchStart = useCallback((e) => {
                if (!enabled) return;
                touchEnd.current = null;
                touchStart.current = e.targetTouches[0].clientX;
            }, [enabled]);

            const onTouchMove = useCallback((e) => {
                if (!enabled) return;
                touchEnd.current = e.targetTouches[0].clientX;
            }, [enabled]);

            const onTouchEnd = useCallback(() => {
                if (!enabled || !touchStart.current || !touchEnd.current) return;
                const distance = touchStart.current - touchEnd.current;
                const isLeftSwipe = distance > threshold;
                const isRightSwipe = distance < -threshold;
                
                if (isLeftSwipe && onSwipeLeft) onSwipeLeft();
                if (isRightSwipe && onSwipeRight) onSwipeRight();
                
                touchStart.current = null;
                touchEnd.current = null;
            }, [enabled, threshold, onSwipeLeft, onSwipeRight]);

            return { onTouchStart, onTouchMove, onTouchEnd };
        };

        // --- PULL TO REFRESH HOOK ---
        const usePullToRefresh = (onRefresh, options = {}) => {
            const { threshold = 80, enabled = true } = options;
            const [pulling, setPulling] = useState(false);
            const [pullDistance, setPullDistance] = useState(0);
            const [refreshing, setRefreshing] = useState(false);
            const startY = React.useRef(null);
            const containerRef = React.useRef(null);

            const handleTouchStart = useCallback((e) => {
                if (!enabled || refreshing) return;
                const scrollTop = window.scrollY || document.documentElement.scrollTop;
                if (scrollTop <= 0) {
                    startY.current = e.touches[0].clientY;
                    setPulling(true);
                }
            }, [enabled, refreshing]);

            const handleTouchMove = useCallback((e) => {
                if (!pulling || !startY.current || refreshing) return;
                const currentY = e.touches[0].clientY;
                const distance = Math.max(0, (currentY - startY.current) * 0.5);
                setPullDistance(Math.min(distance, threshold * 1.5));
            }, [pulling, refreshing, threshold]);

            const handleTouchEnd = useCallback(async () => {
                if (!pulling) return;
                
                if (pullDistance >= threshold && onRefresh) {
                    setRefreshing(true);
                    try {
                        await onRefresh();
                    } finally {
                        setRefreshing(false);
                    }
                }
                
                setPulling(false);
                setPullDistance(0);
                startY.current = null;
            }, [pulling, pullDistance, threshold, onRefresh]);

            const pullIndicator = (pullDistance > 0 || refreshing) ? (
                <div 
                    className="fixed left-0 right-0 flex justify-center z-50 transition-transform duration-200"
                    style={{ 
                        top: 'calc(env(safe-area-inset-top, 0px) + 60px)',
                        transform: `translateY(${refreshing ? 20 : pullDistance - 40}px)`,
                        opacity: refreshing ? 1 : Math.min(pullDistance / threshold, 1)
                    }}
                >
                    <div className={`bg-ink text-white px-4 py-2 rounded-full text-sm font-medium flex items-center gap-2 shadow-lg ${refreshing ? 'animate-pulse' : ''}`}>
                        <Loader2 size={16} className={refreshing ? 'animate-spin' : ''} style={{ transform: `rotate(${pullDistance * 3}deg)` }} />
                        {refreshing ? 'Oppdaterer...' : pullDistance >= threshold ? 'Slipp for å oppdatere' : 'Dra ned...'}
                    </div>
                </div>
            ) : null;

            return {
                containerRef,
                handlers: {
                    onTouchStart: handleTouchStart,
                    onTouchMove: handleTouchMove,
                    onTouchEnd: handleTouchEnd
                },
                pullIndicator,
                refreshing
            };
        };

        // --- API LAYER ---
        const api = {
            getUsers: async () => {
                const res = await fetch('/.netlify/functions/users');
                if (!res.ok) throw new Error('Kunne ikke hente brukere');
                return await res.json();
            },
            createUser: async (newUser) => {
                const res = await fetch('/.netlify/functions/users', { method: 'POST', body: JSON.stringify(newUser) });
                if (!res.ok) throw new Error('Feil ved opprettelse');
                return await res.json();
            },
            deleteUser: async (userId) => {
                const res = await fetch('/.netlify/functions/users', { method: 'DELETE', body: JSON.stringify({ id: userId }) });
                if (!res.ok) throw new Error('Feil ved sletting');
                return await res.json();
            },
            archiveUser: async (userId, archive) => {
                const res = await fetch('/.netlify/functions/users', { method: 'PATCH', body: JSON.stringify({ id: userId, is_archived: archive }) });
                if (!res.ok) throw new Error('Feil ved arkivering');
                return await res.json();
            },
            getUserData: async (userId) => {
                const res = await fetch(`/.netlify/functions/data?id=${userId}`);
                if (!res.ok) throw new Error('Feil ved henting av data');
                return await res.json();
            },
            saveUserData: async (userId, data) => {
                const res = await fetch('/.netlify/functions/data', { method: 'POST', body: JSON.stringify({ userId, type: 'plan_update', data }) });
                if (!res.ok) throw new Error('Lagring feilet');
                return data;
            },
            submitCheckin: async (userId, entry) => {
                 const payload = JSON.stringify({ userId, type: 'new_checkin', data: entry });
                 const res = await fetch('/.netlify/functions/data', { method: 'POST', body: payload });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(errorText || 'Innsending feilet');
                }
            },
            deleteCheckin: async (checkinId) => {
                 const res = await fetch('/.netlify/functions/data', { method: 'POST', body: JSON.stringify({ type: 'delete_checkin', data: { checkinId } }) });
                if (!res.ok) throw new Error('Sletting feilet');
            },
            login: async (username, password) => {
                const res = await fetch('/.netlify/functions/auth', { method: 'POST', body: JSON.stringify({ username, password }) });
                if (res.status === 401) return null; 
                if (!res.ok) throw new Error('Login feilet');
                return await res.json();
            }
        };

        // --- Helpers ---
        const formatWeight = (val) => (!val ? '—' : parseFloat(val).toFixed(1).replace('.', ','));
        
        const formatDateNO = (dateString) => {
            if (!dateString) return '';
            const datePart = dateString.split('T')[0];
            if (datePart.includes('-')) {
                const [year, month, day] = datePart.split('-');
                return `${day}.${month}.${year}`;
            }
            return datePart;
        };

        const getThumbnail = (url) => {
            if (!url || typeof url !== 'string') return url;
            if (!url.includes('cloudinary.com')) return url;
            return url.replace('/upload/', '/upload/w_200,h_200,c_fill,q_auto,f_auto/');
        };

        const getFullSizeImage = (url) => {
            if (!url || typeof url !== 'string') return url;
            if (!url.includes('cloudinary.com')) return url;
            return url.replace('/upload/', '/upload/w_1280,c_limit,q_auto,f_auto/');
        };

        // --- Components (memoized for performance) ---

        const Skeleton = React.memo(({ className }) => (
            <div className={`bg-surface-200 animate-pulse rounded-2xl ${className}`} />
        ));

        const BADGE_VARIANTS = {
            default: 'bg-surface-200 text-ink',
            success: 'bg-emerald-50 text-emerald-700 border border-emerald-200',
            warning: 'bg-amber-50 text-amber-700 border border-amber-200',
            muted: 'bg-surface-100 text-ink-muted',
        };

        const Badge = React.memo(({ children, variant = 'default', className = '' }) => (
            <span className={`inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full ${BADGE_VARIANTS[variant]} ${className}`}>
                {children}
            </span>
        ));

        const BUTTON_VARIANTS = {
            primary: 'bg-ink text-surface-50 hover:bg-accent-hover active:scale-[0.98]',
            secondary: 'bg-surface-100 text-ink hover:bg-surface-200 active:scale-[0.98]',
            ghost: 'text-ink-muted hover:text-ink hover:bg-surface-100',
            danger: 'bg-red-50 text-red-600 hover:bg-red-100',
        };
        const BUTTON_SIZES = {
            sm: 'px-3 py-1.5 text-sm',
            md: 'px-4 py-2.5 text-sm',
            lg: 'px-6 py-3.5 text-base',
        };

        const Button = React.memo(({ children, variant = 'primary', size = 'md', className = '', ...props }) => (
            <button 
                className={`font-medium rounded-xl transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 ${BUTTON_VARIANTS[variant]} ${BUTTON_SIZES[size]} ${className}`}
                {...props}
            >
                {children}
            </button>
        ));

        const Card = React.memo(({ children, className = "", interactive = false, ...props }) => (
            <div 
                className={`bg-white rounded-2xl border border-surface-200 ${interactive ? 'hover:border-surface-300 hover:shadow-sm cursor-pointer transition-all' : ''} ${className}`} 
                {...props}
            >
                {children}
            </div>
        ));

        const ImageModal = React.memo(({ images, initialIndex, onClose }) => {
            const [index, setIndex] = useState(initialIndex || 0);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                document.body.style.overflow = 'hidden';
                return () => { document.body.style.overflow = 'unset'; };
            }, []);

            if (!images || images.length === 0) return null;

            const currentImage = images[index];
            const hasNext = index < images.length - 1;
            const hasPrev = index > 0;

            const handleNext = (e) => { 
                if(e) e.stopPropagation(); 
                if (hasNext) {
                    setLoading(true);
                    setIndex(index + 1); 
                }
            };
            const handlePrev = (e) => { 
                if(e) e.stopPropagation(); 
                if (hasPrev) {
                    setLoading(true);
                    setIndex(index - 1); 
                }
            };

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'ArrowRight' && hasNext) handleNext();
                    if (e.key === 'ArrowLeft' && hasPrev) handlePrev();
                    if (e.key === 'Escape') onClose();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [hasNext, hasPrev, onClose]);

            return (
                <div className="fixed inset-0 z-[100] bg-ink/95 flex items-center justify-center animate-fade-in">
                    <button onClick={onClose} className="absolute right-4 text-white/60 hover:text-white p-2 rounded-full hover:bg-white/10 transition-colors z-[120]" style={{ top: 'calc(env(safe-area-inset-top, 20px) + 12px)' }}>
                        <X size={28} />
                    </button>
                    
                    <div className="relative w-full h-full flex items-center justify-center">
                        <TransformWrapper 
                            key={index} 
                            initialScale={1} 
                            minScale={0.5} 
                            maxScale={4} 
                            centerOnInit={true}
                        >
                            <TransformComponent wrapperStyle={{ width: "100%", height: "100%" }} contentStyle={{ width: "100%", height: "100%", display: "flex", alignItems: "center", justifyContent: "center" }}>
                                {loading && (
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <Loader2 className="text-white animate-spin" size={32} />
                                    </div>
                                )}
                                <img 
                                    src={getFullSizeImage(currentImage)} 
                                    onLoad={() => setLoading(false)}
                                    className={`max-w-full max-h-[90vh] object-contain select-none transition-opacity duration-300 ${loading ? 'opacity-0' : 'opacity-100'}`} 
                                    alt="Fullskjerm" 
                                />
                            </TransformComponent>
                        </TransformWrapper>
                        
                        {hasPrev && (
                            <button onClick={handlePrev} className="absolute left-4 p-3 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all z-[110]">
                                <ChevronLeft size={28} />
                            </button>
                        )}
                        {hasNext && (
                            <button onClick={handleNext} className="absolute right-4 p-3 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all z-[110]">
                                <ChevronRight size={28} />
                            </button>
                        )}
                        {images.length > 1 && (
                            <div className="absolute bottom-8 left-1/2 -translate-x-1/2 text-white/80 font-medium bg-white/10 px-4 py-2 rounded-full text-sm z-[110]">
                                {index + 1} / {images.length}
                            </div>
                        )}
                    </div>
                </div>
            );
        });

        const LoginScreen = React.memo(({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setIsLoading(true);
                try {
                    const user = await api.login(username, password);
                    if (user) onLogin(user);
                    else setError('Feil brukernavn eller passord');
                } catch (err) {
                    setError('Serverfeil. Prøv igjen.');
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-surface-50 relative animate-fade-in">
                    <div className="text-center mb-12">
                        <div className="w-20 h-20 mx-auto mb-8">
                            <img src={APP_ICON} alt="Logo" className="w-full h-full" />
                        </div>
                        <h1 className="text-3xl font-display text-ink mb-2">JNM Coaching</h1>
                        <p className="text-ink-muted">Logg inn for å fortsette</p>
                    </div>

                    <div className="w-full max-w-sm">
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-ink-muted mb-2">Brukernavn</label>
                                <input 
                                    type="text" 
                                    value={username} 
                                    onChange={(e) => setUsername(e.target.value)} 
                                    className="w-full px-4 py-3.5 bg-white border border-surface-200 rounded-xl focus:ring-2 focus:ring-ink focus:border-ink outline-none transition-all" 
                                    placeholder="Skriv inn brukernavn" 
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-ink-muted mb-2">Passord</label>
                                <input 
                                    type="password" 
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)} 
                                    className="w-full px-4 py-3.5 bg-white border border-surface-200 rounded-xl focus:ring-2 focus:ring-ink focus:border-ink outline-none transition-all" 
                                    placeholder="••••••••" 
                                />
                            </div>

                            {error && (
                                <div className="flex items-center gap-2 text-red-600 bg-red-50 border border-red-100 px-4 py-3 rounded-xl text-sm">
                                    <AlertCircle size={16} />
                                    {error}
                                </div>
                            )}

                            <Button type="submit" disabled={isLoading} size="lg" className="w-full mt-6">
                                {isLoading ? (
                                    <Loader2 className="animate-spin" size={20} />
                                ) : (
                                    <>Logg inn <ArrowRight size={18} /></>
                                )}
                            </Button>
                        </form>
                    </div>

                    <p className="absolute bottom-8 text-ink-faint text-xs">JNM Coaching © 2025</p>
                </div>
            );
        });

        const NAV_ITEMS = [
            { id: 'dashboard', label: 'Hjem', icon: Home },
            { id: 'gallery', label: 'Galleri', icon: Camera },
            { id: 'diet', label: 'Mat', icon: Utensils },
            { id: 'workout', label: 'Trening', icon: Dumbbell },
            { id: 'checkin', label: 'Rapport', icon: ClipboardCheck },
        ];

        const Navigation = React.memo(({ activeTab, setActiveTab }) => {
            const handleTabClick = useCallback((id) => {
                setActiveTab(id);
                window.scrollTo({ top: 0, behavior: 'instant' });
            }, [setActiveTab]);

            return (
                <div className="fixed bottom-0 left-0 right-0 glass-nav z-50 border-t border-surface-200"> 
                    <div className="flex justify-around items-center h-16 max-w-md mx-auto">
                        {NAV_ITEMS.map((item) => {
                            const Icon = item.icon;
                            const isActive = activeTab === item.id;
                            return (
                                <button 
                                    key={item.id} 
                                    onClick={() => handleTabClick(item.id)} 
                                    className={`flex flex-col items-center justify-center w-full h-full gap-1 transition-all active:scale-90 ${isActive ? 'text-ink' : 'text-ink-faint'}`}
                                >
                                    <Icon size={22} strokeWidth={isActive ? 2 : 1.5} />
                                    <span className={`text-[10px] font-medium ${isActive ? 'text-ink' : 'text-ink-faint'}`}>{item.label}</span>
                                </button>
                            );
                        })}
                    </div>
                    {/* Safe area spacer for iPhone home indicator */}
                    <div className="safe-area-pb" />
                </div>
            );
        });

        const Header = React.memo(({ title, user, viewingClient, onLogout, onClearClient }) => (
            <header className="bg-surface-50/95 backdrop-blur-md sticky top-0 z-40 border-b border-surface-200">
                {/* Safe area spacer for iPhone Dynamic Island/notch */}
                <div className="safe-area-pt" />
                <div className="flex justify-between items-center max-w-md mx-auto px-5 py-4">
                    <div>
                        <h1 className="text-xl font-display text-ink">{title}</h1>
                        <div className="flex items-center gap-2 mt-0.5">
                            <span className="text-xs text-ink-muted flex items-center gap-1">
                                {user.role === 'coach' ? <Briefcase size={12} /> : <User size={12} />}
                                {user.name}
                            </span>
                            {viewingClient && (
                                <Badge variant="muted" className="text-[10px]">
                                    <ChevronRight size={10} /> {viewingClient.name}
                                </Badge>
                            )}
                        </div>
                    </div>
                    {viewingClient ? (
                        <Button variant="secondary" size="sm" onClick={onClearClient}>Lukk</Button>
                    ) : (
                        <button onClick={onLogout} className="text-ink-faint hover:text-ink p-2 rounded-xl hover:bg-surface-100 transition-colors">
                            <LogOut size={20} />
                        </button>
                    )}
                </div>
            </header>
        ));

        // --- Views ---

        const WeightProgressView = React.memo(({ checkins, onBack }) => {
            const validCheckins = checkins.filter(c => c.weight && parseFloat(c.weight) > 0).sort((a, b) => a.timestamp - b.timestamp);

            if (validCheckins.length === 0) return (
                <div className="flex flex-col items-center justify-center h-[60vh] animate-fade-in text-center px-6">
                    <p className="text-ink-muted font-display text-lg italic mb-6">Ingen vektdata enda</p>
                    <Button variant="secondary" onClick={onBack}>Tilbake</Button>
                </div>
            );

            const first = validCheckins[0];
            const last = validCheckins[validCheckins.length - 1];
            const totalChange = (parseFloat(last.weight) - parseFloat(first.weight)).toFixed(1);
            const isDown = parseFloat(totalChange) < 0;
            const isSame = parseFloat(totalChange) === 0;

            const width = 300;
            const height = 140;
            const padding = 16;
            const weights = validCheckins.map(c => parseFloat(c.weight));
            const minW = Math.min(...weights) - 0.5;
            const maxW = Math.max(...weights) + 0.5;
            const timestamps = validCheckins.map(c => c.timestamp);
            const minT = Math.min(...timestamps);
            const maxT = Math.max(...timestamps);

            const points = validCheckins.map(c => {
                const x = minT === maxT ? width / 2 : ((c.timestamp - minT) / (maxT - minT)) * (width - 2 * padding) + padding;
                const y = minW === maxW ? height / 2 : height - padding - ((parseFloat(c.weight) - minW) / (maxW - minW)) * (height - 2 * padding);
                return `${x},${y}`;
            }).join(' ');

            return (
                <div className="space-y-6 animate-slide-up pb-32">
                    <button onClick={onBack} className="flex items-center gap-2 text-ink-muted hover:text-ink transition-colors">
                        <ChevronLeft size={20} />
                        <span className="text-sm font-medium">Tilbake</span>
                    </button>

                    <div className="grid grid-cols-2 gap-4">
                        <Card className="p-5">
                            <p className="text-xs text-ink-muted uppercase tracking-wide mb-1">Endring</p>
                            <div className={`text-2xl font-semibold flex items-center gap-2 ${isDown ? 'text-emerald-600' : isSame ? 'text-ink-muted' : 'text-ink'}`}>
                                {totalChange > 0 ? '+' : ''}{totalChange.replace('.', ',')} kg
                                {isDown ? <TrendingDown size={20} /> : isSame ? <Minus size={20} /> : <TrendingUp size={20} />}
                            </div>
                        </Card>
                        <Card className="p-5">
                            <p className="text-xs text-ink-muted uppercase tracking-wide mb-1">Nåværende</p>
                            <p className="text-2xl font-semibold">{formatWeight(last.weight)} kg</p>
                        </Card>
                    </div>

                    {validCheckins.length > 1 && (
                        <Card className="p-4">
                            <p className="text-xs text-ink-muted uppercase tracking-wide mb-3">Utvikling</p>
                            <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-32">
                                <defs>
                                    <linearGradient id="lineGradient" x1="0" y1="0" x2="1" y2="0">
                                        <stop offset="0%" stopColor="#A3A3A3" />
                                        <stop offset="100%" stopColor="#171717" />
                                    </linearGradient>
                                </defs>
                                <polyline fill="none" stroke="url(#lineGradient)" strokeWidth="2" points={points} strokeLinecap="round" strokeLinejoin="round" />
                                {validCheckins.map((c, i) => {
                                    const x = minT === maxT ? width / 2 : ((c.timestamp - minT) / (maxT - minT)) * (width - 2 * padding) + padding;
                                    const y = minW === maxW ? height / 2 : height - padding - ((parseFloat(c.weight) - minW) / (maxW - minW)) * (height - 2 * padding);
                                    return <circle key={i} cx={x} cy={y} r="4" fill="#FAFAF9" stroke="#171717" strokeWidth="2" />
                                })}
                            </svg>
                        </Card>
                    )}

                    <div className="space-y-2">
                        <p className="text-xs text-ink-muted uppercase tracking-wide px-1">Historikk</p>
                        {[...validCheckins].reverse().map((entry, i) => {
                            const prev = [...validCheckins].reverse()[i+1];
                            const change = prev ? (parseFloat(entry.weight) - parseFloat(prev.weight)) : 0;
                            
                            return (
                                <Card key={entry.id} className="p-4 flex justify-between items-center">
                                    <div>
                                        <p className="font-medium">{formatDateNO(entry.date)}</p>
                                        <p className="text-xs text-ink-muted">{new Date(entry.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        {prev && change !== 0 && (
                                            <Badge variant={change < 0 ? 'success' : 'muted'}>
                                                {change < 0 ? <TrendingDown size={12}/> : <TrendingUp size={12}/>}
                                                {change > 0 ? '+' : ''}{change.toFixed(1).replace('.', ',')}
                                            </Badge>
                                        )}
                                        <span className="font-semibold text-lg tabular-nums">{formatWeight(entry.weight)}</span>
                                    </div>
                                </Card>
                            )
                        })}
                    </div>
                </div>
            );
        });

        // GalleryView - samler alle bilder fra checkins for lett sammenligning
        const GalleryView = React.memo(({ checkins }) => {
            const [lightbox, setLightbox] = useState({ isOpen: false, images: [], index: 0 });
            const [viewMode, setViewMode] = useState('grid'); // 'grid' eller 'timeline'

            // Samle alle bilder med metadata, sortert fra nyeste til eldste
            const allImages = useMemo(() => {
                const images = [];
                const sortedCheckins = [...checkins].sort((a, b) => b.timestamp - a.timestamp);
                
                sortedCheckins.forEach(checkin => {
                    const checkinImages = checkin.images && checkin.images.length > 0 
                        ? checkin.images 
                        : (checkin.image ? [checkin.image] : []);
                    
                    checkinImages.forEach(img => {
                        images.push({
                            url: img,
                            date: checkin.date,
                            timestamp: checkin.timestamp,
                            weight: checkin.weight,
                            checkinId: checkin.id
                        });
                    });
                });
                
                return images;
            }, [checkins]);

            // Grupper bilder etter måned for timeline-visning
            const imagesByMonth = useMemo(() => {
                const grouped = {};
                allImages.forEach(img => {
                    const date = new Date(img.timestamp);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const monthLabel = date.toLocaleDateString('no-NO', { month: 'long', year: 'numeric' });
                    
                    if (!grouped[monthKey]) {
                        grouped[monthKey] = { label: monthLabel, images: [] };
                    }
                    grouped[monthKey].images.push(img);
                });
                return Object.entries(grouped).sort((a, b) => b[0].localeCompare(a[0]));
            }, [allImages]);

            const closeLightbox = useCallback(() => {
                setLightbox(prev => ({ ...prev, isOpen: false }));
            }, []);

            const openLightbox = useCallback((index) => {
                setLightbox({ isOpen: true, images: allImages.map(img => img.url), index });
            }, [allImages]);

            if (allImages.length === 0) {
                return (
                    <div className="flex flex-col items-center justify-center h-[60vh] animate-fade-in text-center px-6">
                        <div className="w-16 h-16 bg-surface-100 rounded-2xl flex items-center justify-center text-ink-muted mb-6">
                            <Camera size={32} />
                        </div>
                        <p className="text-ink-muted font-display text-lg italic mb-2">Ingen bilder enda</p>
                        <p className="text-ink-faint text-sm">Bilder fra ukesrapporter vil vises her</p>
                    </div>
                );
            }

            return (
                <div className="space-y-5 pb-32 animate-slide-up">
                    {lightbox.isOpen && (
                        <ImageModal 
                            images={lightbox.images} 
                            initialIndex={lightbox.index} 
                            onClose={closeLightbox} 
                        />
                    )}

                    {/* Header med visningsvalg */}
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="font-display text-xl">Fremgangsgalleri</h2>
                            <p className="text-sm text-ink-muted">{allImages.length} bilder</p>
                        </div>
                        <div className="flex gap-1 bg-surface-100 p-1 rounded-lg">
                            <button
                                onClick={() => setViewMode('grid')}
                                className={`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${viewMode === 'grid' ? 'bg-white shadow-sm text-ink' : 'text-ink-muted'}`}
                            >
                                Rutenett
                            </button>
                            <button
                                onClick={() => setViewMode('timeline')}
                                className={`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${viewMode === 'timeline' ? 'bg-white shadow-sm text-ink' : 'text-ink-muted'}`}
                            >
                                Tidslinje
                            </button>
                        </div>
                    </div>

                    {viewMode === 'grid' ? (
                        /* Grid-visning - kompakt oversikt */
                        <div className="grid grid-cols-3 gap-1.5">
                            {allImages.map((img, idx) => (
                                <div 
                                    key={`${img.checkinId}-${idx}`}
                                    className="relative aspect-square cursor-pointer group"
                                    onClick={() => openLightbox(idx)}
                                >
                                    <img 
                                        src={getThumbnail(img.url)} 
                                        loading="lazy"
                                        className="w-full h-full object-cover rounded-lg"
                                        alt={`Fremgang ${formatDateNO(img.date)}`}
                                    />
                                    <div className="absolute inset-0 bg-gradient-to-t from-ink/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-lg">
                                        <div className="absolute bottom-2 left-2 right-2">
                                            <p className="text-white text-xs font-medium">{formatDateNO(img.date)}</p>
                                            {img.weight && (
                                                <p className="text-white/70 text-[10px]">{formatWeight(img.weight)} kg</p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        /* Timeline-visning - gruppert etter måned */
                        <div className="space-y-6">
                            {imagesByMonth.map(([monthKey, { label, images }]) => (
                                <div key={monthKey}>
                                    <div className="flex items-center gap-3 mb-3">
                                        <h3 className="text-sm font-medium text-ink-muted capitalize">{label}</h3>
                                        <div className="flex-1 h-px bg-surface-200" />
                                        <span className="text-xs text-ink-faint">{images.length} bilder</span>
                                    </div>
                                    <div className="grid grid-cols-3 gap-1.5">
                                        {images.map((img, idx) => {
                                            const globalIndex = allImages.findIndex(i => i.url === img.url && i.timestamp === img.timestamp);
                                            return (
                                                <div 
                                                    key={`${img.checkinId}-${idx}`}
                                                    className="relative aspect-square cursor-pointer group"
                                                    onClick={() => openLightbox(globalIndex)}
                                                >
                                                    <img 
                                                        src={getThumbnail(img.url)} 
                                                        loading="lazy"
                                                        className="w-full h-full object-cover rounded-lg"
                                                        alt={`Fremgang ${formatDateNO(img.date)}`}
                                                    />
                                                    <div className="absolute inset-0 bg-gradient-to-t from-ink/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity rounded-lg">
                                                        <div className="absolute bottom-2 left-2 right-2">
                                                            <p className="text-white text-xs font-medium">{formatDateNO(img.date)}</p>
                                                            {img.weight && (
                                                                <p className="text-white/70 text-[10px]">{formatWeight(img.weight)} kg</p>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Sammenligningstips */}
                    {allImages.length >= 2 && (
                        <Card className="p-4 bg-surface-50 border-dashed">
                            <p className="text-sm text-ink-muted text-center">
                                💡 Trykk på et bilde og sveip for å sammenligne fremgangen din
                            </p>
                        </Card>
                    )}
                </div>
            );
        });

        // Motiverende sitater - statisk, flyttes utenfor komponenten
        const QUOTES = [
            { text: "Små steg hver dag fører til store resultater.", author: "Ukjent" },
            { text: "Du trenger ikke være perfekt, bare konsistent.", author: "Ukjent" },
            { text: "Kroppen oppnår det sinnet tror på.", author: "Ukjent" },
            { text: "Fremgang, ikke perfeksjon.", author: "Ukjent" },
            { text: "Den eneste dårlige treningen er den som ikke ble gjort.", author: "Ukjent" },
            { text: "Disiplin er broen mellom mål og resultater.", author: "Jim Rohn" },
        ];

        const DashboardView = React.memo(({ userData, isCoach, onUpdateData, onOpenWeightHistory }) => {
            const checkins = userData.checkins || [];
            
            // Memoize sorterte checkins og lastCheckin
            const { sortedCheckins, lastCheckin } = useMemo(() => {
                const sorted = [...checkins].sort((a, b) => b.timestamp - a.timestamp);
                return { sortedCheckins: sorted, lastCheckin: sorted.length > 0 ? sorted[0] : null };
            }, [checkins]);

            // Memoize week calculation
            const { currentWeek, progress } = useMemo(() => {
                if (!userData.startDate) return { currentWeek: 1, progress: 0 };
                const start = new Date(userData.startDate);
                const end = userData.isPaused && userData.pausedAt ? new Date(userData.pausedAt) : new Date();
                const diffTime = Math.max(0, end - start);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                const week = Math.floor(diffDays / 7) + 1;
                const prog = Math.min((week / (userData.totalWeeks || 12)) * 100, 100);
                return { currentWeek: week, progress: prog };
            }, [userData.startDate, userData.isPaused, userData.pausedAt, userData.totalWeeks]);

            // Beregn statistikk fra alle innsjekker
            const stats = useMemo(() => {
                if (checkins.length === 0) return null;
                
                const totalStrength = checkins.reduce((sum, c) => sum + (parseInt(c.strengthSessions) || 0), 0);
                const totalCardio = checkins.reduce((sum, c) => sum + (parseInt(c.cardioSessions) || 0), 0);
                const stepsHit = checkins.filter(c => c.stepsReached).length;
                const avgAccuracy = (checkins.reduce((sum, c) => sum + (parseInt(c.accuracy) || 0), 0) / checkins.length).toFixed(1);
                
                // Vektendring
                const validWeights = checkins.filter(c => c.weight && parseFloat(c.weight) > 0).sort((a, b) => a.timestamp - b.timestamp);
                let weightChange = null;
                if (validWeights.length >= 2) {
                    const first = parseFloat(validWeights[0].weight);
                    const last = parseFloat(validWeights[validWeights.length - 1].weight);
                    weightChange = (last - first).toFixed(1);
                }
                
                return { totalStrength, totalCardio, stepsHit, avgAccuracy, weightChange, totalCheckins: checkins.length };
            }, [checkins]);

            // Memoize dagens quote
            const todayQuote = useMemo(() => QUOTES[new Date().getDay() % QUOTES.length], []);

            const handlePlanSettings = useCallback(async () => {
                if (!isCoach) return;
                const choice = prompt(`Plan-innstillinger:\n\n1. Sett startdato\n2. Endre antall uker\n3. ${userData.isPaused ? 'Fortsett plan' : 'Pause plan'}`);
                if (choice === '1') {
                    const dateStr = prompt("Startdato (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
                    if (dateStr) await onUpdateData({ startDate: new Date(dateStr).toISOString() });
                } else if (choice === '2') {
                    const weeks = prompt("Totalt antall uker:", userData.totalWeeks || 12);
                    if (weeks) await onUpdateData('totalWeeks', parseInt(weeks));
                } else if (choice === '3') {
                    if (userData.isPaused) {
                        if(confirm("Gjenoppta plan?")) await onUpdateData({ action: 'resume' });
                    } else {
                        if(confirm("Sett plan på pause?")) await onUpdateData({ action: 'pause' });
                    }
                }
            }, [isCoach, userData.isPaused, userData.totalWeeks, onUpdateData]);

            const handleEditGoal = useCallback(async () => {
                const input = prompt("Nytt skrittmål:", userData.stepGoal || 10000);
                if (input && !isNaN(parseInt(input))) await onUpdateData('stepGoal', parseInt(input));
            }, [userData.stepGoal, onUpdateData]);

            return (
                <div className="space-y-5 pb-32 animate-slide-up">
                    {/* Hero Card */}
                    <div className="p-6 bg-ink text-white rounded-2xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-40 h-40 bg-white/5 rounded-full blur-3xl transform translate-x-10 -translate-y-10" />
                        <div className="relative z-10">
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <p className="text-white/60 text-sm">
                                        {userData.isPaused ? 'Plan på pause' : userData.startDate ? 'Din fremgang' : 'Velkommen'}
                                    </p>
                                    <h2 className="text-3xl font-display mt-1">
                                        {userData.isPaused ? 'Pauset' : userData.startDate ? `Uke ${currentWeek}` : 'Kom i gang'}
                                    </h2>
                                </div>
                                {isCoach && (
                                    <button 
                                        onClick={handlePlanSettings}
                                        className="p-2 rounded-lg hover:bg-white/10 text-white/60 transition-colors"
                                    >
                                        <Edit2 size={18} />
                                    </button>
                                )}
                            </div>

                            {userData.startDate && !userData.isPaused && (
                                <div className="space-y-2">
                                    <div className="flex justify-between text-sm">
                                        <span className="text-white/60">Fremdrift</span>
                                        <span className="font-medium">{Math.round(progress)}%</span>
                                    </div>
                                    <div className="h-2 bg-white/20 rounded-full overflow-hidden">
                                        <div 
                                            className="h-full bg-white rounded-full transition-all duration-500" 
                                            style={{ width: `${progress}%` }}
                                        />
                                    </div>
                                    <p className="text-white/40 text-xs text-right">{userData.totalWeeks || 12} uker totalt</p>
                                </div>
                            )}

                            {!userData.startDate && (
                                <p className="text-white/60 text-sm">
                                    {isCoach ? 'Trykk på blyanten for å sette startdato' : 'Venter på at coach setter opp planen'}
                                </p>
                            )}

                            {userData.isPaused && (
                                <p className="text-white/60 text-sm">
                                    {isCoach ? 'Trykk på blyanten for å gjenoppta' : 'Planen er satt på pause'}
                                </p>
                            )}
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-2 gap-4">
                        <Card 
                            className="p-5 group"
                            interactive
                            onClick={onOpenWeightHistory}
                        >
                            <div className="flex justify-between items-start mb-3">
                                <div className="w-10 h-10 bg-surface-100 rounded-xl flex items-center justify-center text-ink-muted group-hover:bg-surface-200 transition-colors">
                                    <Scale size={20} />
                                </div>
                                <ChevronRight size={16} className="text-ink-faint" />
                            </div>
                            <p className="text-xs text-ink-muted uppercase tracking-wide">Siste vekt</p>
                            <p className="text-2xl font-semibold mt-1">
                                {lastCheckin ? formatWeight(lastCheckin.weight) : '—'}
                                <span className="text-sm font-normal text-ink-muted ml-1">kg</span>
                            </p>
                        </Card>

                        <Card className="p-5 relative">
                            <div className="flex justify-between items-start mb-3">
                                <div className="w-10 h-10 bg-surface-100 rounded-xl flex items-center justify-center text-ink-muted">
                                    <Footprints size={20} />
                                </div>
                                {isCoach && (
                                    <button onClick={handleEditGoal} className="text-ink-faint hover:text-ink p-1">
                                        <Edit2 size={14} />
                                    </button>
                                )}
                            </div>
                            <p className="text-xs text-ink-muted uppercase tracking-wide">Skrittmål</p>
                            <p className="text-2xl font-semibold mt-1">{(userData.stepGoal || 10000).toLocaleString()}</p>
                        </Card>
                    </div>

                    {/* Last Report */}
                    {lastCheckin && (
                        <div>
                            <p className="text-xs text-ink-muted uppercase tracking-wide mb-3 px-1">Siste rapport</p>
                            <Card className="divide-y divide-surface-100">
                                <div className="p-4 flex justify-between items-center">
                                    <span className="text-ink-muted">Nøyaktighet</span>
                                    <Badge>{lastCheckin.accuracy}/10</Badge>
                                </div>
                                <div className="p-4 flex justify-between items-center">
                                    <span className="text-ink-muted">Styrke / Cardio</span>
                                    <div className="flex gap-2">
                                        <Badge><Dumbbell size={12} /> {lastCheckin.strengthSessions}</Badge>
                                        <Badge><Activity size={12} /> {lastCheckin.cardioSessions || 0}</Badge>
                                    </div>
                                </div>
                                <div className="p-4 flex justify-between items-center">
                                    <span className="text-ink-muted">Energi / Søvn</span>
                                    <div className="flex gap-2">
                                        <Badge><Zap size={12} /> {lastCheckin.energy}</Badge>
                                        <Badge><Moon size={12} /> {lastCheckin.sleep}</Badge>
                                    </div>
                                </div>
                                <div className="p-4 flex justify-between items-center">
                                    <span className="text-ink-muted">Skrittmål</span>
                                    <Badge variant={lastCheckin.stepsReached ? 'success' : 'muted'}>
                                        {lastCheckin.stepsReached ? <><Check size={12} /> Oppnådd</> : 'Ikke nådd'}
                                    </Badge>
                                </div>
                            </Card>
                        </div>
                    )}

                    {/* Totaloversikt - kun hvis det finnes data */}
                    {stats && (
                        <div>
                            <p className="text-xs text-ink-muted uppercase tracking-wide mb-3 px-1">Din reise så langt</p>
                            <Card className="p-5">
                                <div className="grid grid-cols-4 gap-3 text-center mb-5">
                                    <div>
                                        <div className="text-2xl font-semibold text-ink">{stats.totalStrength}</div>
                                        <div className="text-[10px] text-ink-muted uppercase tracking-wide mt-1">Styrkeøkter</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-semibold text-ink">{stats.totalCardio}</div>
                                        <div className="text-[10px] text-ink-muted uppercase tracking-wide mt-1">Cardio</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-semibold text-ink">{stats.stepsHit}/{stats.totalCheckins}</div>
                                        <div className="text-[10px] text-ink-muted uppercase tracking-wide mt-1">Skrittmål</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-semibold text-ink">{stats.avgAccuracy}</div>
                                        <div className="text-[10px] text-ink-muted uppercase tracking-wide mt-1">Snitt nøyakt.</div>
                                    </div>
                                </div>
                                
                                {stats.weightChange && (
                                    <div className={`flex items-center justify-center gap-2 py-3 px-4 rounded-xl ${parseFloat(stats.weightChange) < 0 ? 'bg-emerald-50 text-emerald-700' : parseFloat(stats.weightChange) > 0 ? 'bg-surface-100 text-ink' : 'bg-surface-100 text-ink-muted'}`}>
                                        {parseFloat(stats.weightChange) < 0 ? <TrendingDown size={18} /> : parseFloat(stats.weightChange) > 0 ? <TrendingUp size={18} /> : <Minus size={18} />}
                                        <span className="font-medium">
                                            {parseFloat(stats.weightChange) > 0 ? '+' : ''}{stats.weightChange.replace('.', ',')} kg total endring
                                        </span>
                                    </div>
                                )}
                            </Card>
                        </div>
                    )}

                    {/* Dagens motivasjon */}
                    <Card className="p-6 bg-gradient-to-br from-surface-50 to-surface-100 border-dashed">
                        <div className="text-center">
                            <p className="font-display text-lg text-ink italic leading-relaxed">"{todayQuote.text}"</p>
                            <p className="text-xs text-ink-muted mt-3">— {todayQuote.author}</p>
                        </div>
                    </Card>
                </div>
            );
        });

        const PlanSection = React.memo(({ type, content, onSave, isReadOnly }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [text, setText] = useState(content);
            useEffect(() => setText(content), [content]);
            
            const Icon = type === 'diet' ? Utensils : Dumbbell;
            const title = type === 'diet' ? 'Matplan' : 'Treningsplan';

            const handleToggleEdit = useCallback(() => {
                if (isEditing) onSave(text);
                setIsEditing(prev => !prev);
            }, [isEditing, text, onSave]);

            const handleTextChange = useCallback((e) => setText(e.target.value), []);

            // Memoize parsed markdown
            const parsedContent = useMemo(() => {
                return text ? window.marked.parse(text) : '<p class="text-ink-muted italic text-center py-12">Ingen plan enda</p>';
            }, [text]);

            return (
                <div className="space-y-5 pb-32 animate-slide-up">
                    <Card className="overflow-hidden">
                        <div className="flex justify-between items-center p-5 border-b border-surface-100">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-surface-100 rounded-xl flex items-center justify-center text-ink-muted">
                                    <Icon size={20} />
                                </div>
                                <h2 className="font-display text-xl">{title}</h2>
                            </div>
                            {!isReadOnly && (
                                <Button 
                                    variant={isEditing ? 'primary' : 'secondary'}
                                    size="sm"
                                    onClick={handleToggleEdit}
                                >
                                    {isEditing ? <><Check size={16} /> Lagre</> : <><Edit2 size={16} /> Rediger</>}
                                </Button>
                            )}
                        </div>

                        <div className="p-5">
                            {isEditing && !isReadOnly ? (
                                <textarea 
                                    value={text} 
                                    onChange={handleTextChange} 
                                    className="w-full min-h-[60vh] p-4 bg-surface-50 rounded-xl border border-surface-200 focus:ring-2 focus:ring-ink focus:border-ink outline-none text-ink font-mono text-sm leading-relaxed resize-none" 
                                    placeholder="Skriv planen her..."
                                />
                            ) : (
                                <div 
                                    className="prose prose-sm max-w-none" 
                                    dangerouslySetInnerHTML={{ __html: parsedContent }} 
                                />
                            )}
                        </div>
                    </Card>
                </div>
            );
        });

        // Flytt sub-komponenter utenfor CheckInView for å unngå re-deklarering
        const InputLabel = React.memo(({ children }) => (
            <label className="block text-sm font-medium text-ink-muted mb-2">{children}</label>
        ));

        const SelectField = React.memo(({ label, value, onChange, options }) => (
            <div>
                <InputLabel>{label}</InputLabel>
                <div className="relative">
                    <select 
                        value={value} 
                        onChange={onChange} 
                        className="w-full p-3.5 bg-surface-50 border border-surface-200 rounded-xl appearance-none focus:ring-2 focus:ring-ink focus:border-ink outline-none font-medium cursor-pointer"
                    >
                        {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                    </select>
                    <ChevronDown className="absolute right-3 top-1/2 -translate-y-1/2 text-ink-muted pointer-events-none" size={18} />
                </div>
            </div>
        ));

        // Pre-generate options arrays outside component
        const OPTIONS_1_TO_10 = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
        const OPTIONS_0_TO_7 = [0, 1, 2, 3, 4, 5, 6, 7];
        const INITIAL_FORM_DATA = {
            weight: '', sleep: 5, energy: 5, accuracy: 10,
            strengthSessions: 0, cardioSessions: 0,
            stepsReached: false, takenSupplements: false,
            comment: '', images: []
        };

        const CheckInView = React.memo(({ checkins, onNewCheckin, onDelete, isReadOnly, stepGoal, hideForm = false }) => {
            const [step, setStep] = useState('form');
            const [lightbox, setLightbox] = useState({ isOpen: false, images: [], index: 0 });
            const [isCompressing, setIsCompressing] = useState(false);
            const [errorMessage, setErrorMessage] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [formData, setFormData] = useState(INITIAL_FORM_DATA);

            const closeLightbox = useCallback(() => {
                setLightbox(prev => ({ ...prev, isOpen: false }));
            }, []);

            const openLightbox = useCallback((images, index) => {
                setLightbox({ isOpen: true, images, index });
            }, []);

            const handleImageUpload = useCallback(async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                setIsCompressing(true);
                try {
                    const cloudName = 'drg4fxboh'; 
                    const uploadPreset = 'jnm_upload'; 
                    const uploadPromises = files.map(async (file) => {
                        const fd = new FormData();
                        fd.append('file', file);
                        fd.append('upload_preset', uploadPreset); 
                        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, { method: 'POST', body: fd });
                        if (!res.ok) throw new Error('Opplasting feilet');
                        return (await res.json()).secure_url;
                    });
                    const uploadedUrls = await Promise.all(uploadPromises);
                    setFormData(prev => ({ ...prev, images: [...prev.images, ...uploadedUrls] }));
                } catch (err) {
                    console.error(err);
                    setErrorMessage("Bildeopplasting feilet.");
                } finally {
                    setIsCompressing(false);
                }
            }, []);

            const removeImage = useCallback((indexToRemove) => {
                setFormData(prev => ({ ...prev, images: prev.images.filter((_, index) => index !== indexToRemove) }));
            }, []);

            const handleSubmit = useCallback(async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                setErrorMessage('');
                try {
                    const newEntry = { 
                        id: Date.now(), 
                        date: new Date().toISOString().split('T')[0], 
                        timestamp: Date.now(), 
                        ...formData 
                    };
                    await onNewCheckin(newEntry);
                    setStep('success');
                    createConfetti(); // 🎉 Konfetti!
                    setTimeout(() => {
                        setStep('form');
                        setFormData(INITIAL_FORM_DATA);
                    }, 2500);
                } catch (error) {
                    setErrorMessage('Feil: ' + error.message);
                } finally {
                    setIsSubmitting(false);
                }
            }, [formData, onNewCheckin]);

            // Memoize sorted checkins
            const sortedCheckins = useMemo(() => 
                [...checkins].sort((a, b) => b.timestamp - a.timestamp), 
                [checkins]
            );

            // Form field handlers - memoized
            const updateField = useCallback((field, value) => {
                setFormData(prev => ({ ...prev, [field]: value }));
            }, []);

            if (step === 'success') {
                return (
                    <div className="flex flex-col items-center justify-center h-[60vh] animate-scale-in text-center px-6">
                        <div className="w-16 h-16 bg-emerald-50 rounded-2xl flex items-center justify-center text-emerald-600 mb-6">
                            <Check size={32} strokeWidth={2.5} />
                        </div>
                        <h2 className="text-2xl font-display mb-2">Rapport sendt</h2>
                        <p className="text-ink-muted">Oppdateringen din er lagret</p>
                    </div>
                );
            }

            return (
                <div className="space-y-5 pb-32 animate-slide-up">
                    {lightbox.isOpen && (
                        <ImageModal images={lightbox.images} initialIndex={lightbox.index} onClose={closeLightbox} />
                    )}

                    {!isReadOnly && !hideForm && (
                        <form onSubmit={handleSubmit} className="space-y-5">
                            <Card className="p-5 space-y-5">
                                <h3 className="font-display text-lg">Ny ukesrapport</h3>
                                
                                <div>
                                    <InputLabel>Vekt (kg)</InputLabel>
                                    <div className="relative">
                                        <Scale className="absolute left-4 top-1/2 -translate-y-1/2 text-ink-muted" size={18} />
                                        <input 
                                            type="number" 
                                            inputMode="decimal" 
                                            step="0.1" 
                                            required 
                                            value={formData.weight} 
                                            onChange={(e) => updateField('weight', e.target.value)} 
                                            className="w-full pl-12 pr-4 py-3.5 bg-surface-50 border border-surface-200 rounded-xl outline-none focus:ring-2 focus:ring-ink focus:border-ink font-medium text-lg placeholder-ink-faint" 
                                            placeholder="0.0" 
                                        />
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <SelectField 
                                        label="Energi" 
                                        value={formData.energy} 
                                        onChange={(e) => updateField('energy', e.target.value)} 
                                        options={OPTIONS_1_TO_10} 
                                    />
                                    <SelectField 
                                        label="Søvn" 
                                        value={formData.sleep} 
                                        onChange={(e) => updateField('sleep', e.target.value)} 
                                        options={OPTIONS_1_TO_10} 
                                    />
                                </div>
                                
                                <SelectField 
                                    label={`Nøyaktighet (${formData.accuracy}/10)`}
                                    value={formData.accuracy} 
                                    onChange={(e) => updateField('accuracy', e.target.value)} 
                                    options={OPTIONS_1_TO_10} 
                                />

                                <div className="grid grid-cols-2 gap-4">
                                    <SelectField 
                                        label="Styrkeøkter" 
                                        value={formData.strengthSessions} 
                                        onChange={(e) => updateField('strengthSessions', e.target.value)} 
                                        options={OPTIONS_0_TO_7} 
                                    />
                                    <SelectField 
                                        label="Cardio" 
                                        value={formData.cardioSessions} 
                                        onChange={(e) => updateField('cardioSessions', e.target.value)} 
                                        options={OPTIONS_0_TO_7} 
                                    />
                                </div>

                                <div className="space-y-3">
                                    <label className={`flex items-center gap-4 p-4 rounded-xl cursor-pointer border transition-all ${formData.stepsReached ? 'bg-emerald-50 border-emerald-200' : 'bg-surface-50 border-surface-200'}`}>
                                        <input 
                                            type="checkbox" 
                                            checked={formData.stepsReached} 
                                            onChange={(e) => updateField('stepsReached', e.target.checked)} 
                                            className="w-5 h-5 rounded-md border-surface-300 text-ink focus:ring-ink cursor-pointer" 
                                        />
                                        <div>
                                            <p className="font-medium">Skrittmål oppnådd</p>
                                            <p className="text-sm text-ink-muted">{stepGoal?.toLocaleString() || '10 000'} skritt</p>
                                        </div>
                                    </label>
                                    <label className={`flex items-center gap-4 p-4 rounded-xl cursor-pointer border transition-all ${formData.takenSupplements ? 'bg-emerald-50 border-emerald-200' : 'bg-surface-50 border-surface-200'}`}>
                                        <input 
                                            type="checkbox" 
                                            checked={formData.takenSupplements} 
                                            onChange={(e) => updateField('takenSupplements', e.target.checked)} 
                                            className="w-5 h-5 rounded-md border-surface-300 text-ink focus:ring-ink cursor-pointer" 
                                        />
                                        <div>
                                            <p className="font-medium">Kosttilskudd tatt</p>
                                            <p className="text-sm text-ink-muted">Dagens dose</p>
                                        </div>
                                    </label>
                                </div>

                                <div>
                                    <InputLabel>Kommentar</InputLabel>
                                    <textarea 
                                        value={formData.comment} 
                                        onChange={(e) => updateField('comment', e.target.value)} 
                                        className="w-full px-4 py-3.5 bg-surface-50 border border-surface-200 rounded-xl h-28 outline-none resize-none focus:ring-2 focus:ring-ink focus:border-ink" 
                                        placeholder="Hvordan har uken vært?" 
                                    />
                                </div>
                            </Card>

                            {/* Image Upload */}
                            <Card className="p-5">
                                {formData.images.length > 0 && (
                                    <div className="grid grid-cols-4 gap-2 mb-4">
                                        {formData.images.map((img, idx) => (
                                            <div key={idx} className="relative aspect-square">
                                                <img 
                                                    src={getThumbnail(img)} 
                                                    className="w-full h-full object-cover rounded-lg cursor-pointer" 
                                                    alt="Preview" 
                                                    onClick={() => setLightbox({ isOpen: true, images: formData.images, index: idx })} 
                                                />
                                                <button 
                                                    type="button" 
                                                    onClick={() => removeImage(idx)} 
                                                    className="absolute -top-1.5 -right-1.5 bg-ink text-white p-1 rounded-full"
                                                >
                                                    <X size={12} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                <label className={`flex flex-col items-center justify-center p-8 border-2 border-dashed border-surface-200 rounded-xl cursor-pointer hover:border-surface-300 hover:bg-surface-50 transition-all ${isCompressing ? 'opacity-50 pointer-events-none' : ''}`}>
                                    {isCompressing ? (
                                        <Loader2 className="animate-spin text-ink-muted" size={24} />
                                    ) : (
                                        <>
                                            <Camera size={24} className="text-ink-muted mb-2" />
                                            <span className="font-medium text-ink-muted">Last opp bilder</span>
                                        </>
                                    )}
                                    <input type="file" accept="image/*" multiple className="hidden" onChange={handleImageUpload} />
                                </label>
                            </Card>

                            {errorMessage && (
                                <div className="flex items-center gap-3 bg-red-50 border border-red-100 text-red-700 px-4 py-3 rounded-xl text-sm">
                                    <AlertCircle size={18} />
                                    {errorMessage}
                                </div>
                            )}

                            <Button type="submit" size="lg" className="w-full" disabled={isSubmitting || isCompressing}>
                                {isSubmitting ? <Loader2 className="animate-spin" size={20} /> : <Save size={20} />} 
                                {isSubmitting ? 'Sender...' : 'Send rapport'}
                            </Button>
                        </form>
                    )}

                    {/* History */}
                    <div className={!isReadOnly && !hideForm ? "pt-8 border-t border-surface-200" : ""}>
                        <p className="text-xs text-ink-muted uppercase tracking-wide mb-4 px-1">Tidligere rapporter</p>
                        
                        {sortedCheckins.length === 0 ? (
                            <div className="text-center text-ink-muted py-12 font-display italic">Ingen historikk enda</div>
                        ) : (
                            <div className="space-y-3">
                                {sortedCheckins.map((entry) => {
                                    const displayImages = entry.images && entry.images.length > 0 ? entry.images : (entry.image ? [entry.image] : []);
                                    
                                    return (
                                        <Card key={entry.id} className="p-5 group">
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <p className="font-medium">{formatDateNO(entry.date)}</p>
                                                    <p className="text-xs text-ink-muted">{new Date(entry.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    {isReadOnly && (
                                                        <button 
                                                            onClick={() => { if(confirm('Slett denne rapporten?')) onDelete(entry.id); }} 
                                                            className="opacity-0 group-hover:opacity-100 transition-opacity p-2 text-ink-faint hover:text-red-500"
                                                        >
                                                            <Trash2 size={16} />
                                                        </button>
                                                    )}
                                                    <Badge>{formatWeight(entry.weight)} kg</Badge>
                                                </div>
                                            </div>
                                            
                                            <div className="grid grid-cols-3 gap-2 text-xs mb-4">
                                                <div className="bg-surface-50 p-3 rounded-lg text-center">
                                                    <p className="text-ink-faint mb-1">Nøyaktighet</p>
                                                    <p className="font-semibold">{entry.accuracy}/10</p>
                                                </div>
                                                <div className="bg-surface-50 p-3 rounded-lg text-center">
                                                    <p className="text-ink-faint mb-1">Styrke / Cardio</p>
                                                    <p className="font-semibold">{entry.strengthSessions} / {entry.cardioSessions || 0}</p>
                                                </div>
                                                <div className="bg-surface-50 p-3 rounded-lg text-center">
                                                    <p className="text-ink-faint mb-1">Energi / Søvn</p>
                                                    <p className="font-semibold">{entry.energy} / {entry.sleep}</p>
                                                </div>
                                            </div>

                                            <div className="flex gap-2 mb-4">
                                                <Badge variant={entry.stepsReached ? 'success' : 'muted'}>
                                                    <Footprints size={12} />
                                                    {entry.stepsReached ? 'Skrittmål' : 'Under mål'}
                                                </Badge>
                                                <Badge variant={entry.takenSupplements ? 'success' : 'muted'}>
                                                    {entry.takenSupplements ? <Check size={12} /> : <X size={12} />}
                                                    Tilskudd
                                                </Badge>
                                            </div>

                                            {entry.comment && (
                                                <p className="text-sm text-ink-muted bg-surface-50 p-3 rounded-lg italic mb-4">"{entry.comment}"</p>
                                            )}
                                            
                                            {displayImages.length > 0 && (
                                                <div className="flex gap-2 overflow-x-auto hide-scrollbar">
                                                    {displayImages.map((img, idx) => (
                                                        <img 
                                                            key={idx} 
                                                            src={getThumbnail(img)} 
                                                            loading="lazy" 
                                                            className="w-16 h-16 object-cover rounded-lg cursor-pointer flex-none" 
                                                            alt="Checkin" 
                                                            onClick={() => openLightbox(displayImages, idx)} 
                                                        />
                                                    ))}
                                                </div>
                                            )}
                                        </Card>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        });

        const CoachDashboard = React.memo(({ user, allUsers, onSelectClient, onAddClient, onDeleteClient, onArchiveClient }) => {
            const [showModal, setShowModal] = useState(false);
            const [showArchived, setShowArchived] = useState(false);
            
            // Memoize filtrerte lister
            const { activeClients, archivedClients, totalAthletes } = useMemo(() => ({
                activeClients: allUsers.filter(u => u.role === 'athlete' && !u.is_archived),
                archivedClients: allUsers.filter(u => u.role === 'athlete' && u.is_archived),
                totalAthletes: allUsers.filter(u => u.role === 'athlete').length
            }), [allUsers]);

            const displayedClients = showArchived ? archivedClients : activeClients;

            const closeModal = useCallback(() => setShowModal(false), []);
            const openModal = useCallback(() => setShowModal(true), []);
            const showActive = useCallback(() => setShowArchived(false), []);
            const showArchivedClients = useCallback(() => setShowArchived(true), []);

            const handleFormSubmit = useCallback((e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                onAddClient(Object.fromEntries(fd));
                setShowModal(false);
            }, [onAddClient]);

            return (
                <div className="space-y-5 pb-32 animate-slide-up">
                    {showModal && (
                        <div className="fixed inset-0 bg-ink/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                            <Card className="w-full max-w-sm p-6 animate-scale-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-display">Ny utøver</h2>
                                    <button onClick={closeModal} className="text-ink-muted hover:text-ink p-1">
                                        <X size={20} />
                                    </button>
                                </div>
                                <form onSubmit={handleFormSubmit} className="space-y-4">
                                    <input required name="name" type="text" placeholder="Fullt navn" className="w-full p-3.5 bg-surface-50 border border-surface-200 rounded-xl outline-none focus:ring-2 focus:ring-ink" />
                                    <input required name="username" type="text" placeholder="Brukernavn" className="w-full p-3.5 bg-surface-50 border border-surface-200 rounded-xl outline-none focus:ring-2 focus:ring-ink" />
                                    <input required name="password" type="text" placeholder="Passord" className="w-full p-3.5 bg-surface-50 border border-surface-200 rounded-xl outline-none focus:ring-2 focus:ring-ink" />
                                    <Button type="submit" size="lg" className="w-full">Opprett utøver</Button>
                                </form>
                            </Card>
                        </div>
                    )}
                    
                    {/* Hero Stats Card */}
                    <div className="p-6 bg-ink text-white rounded-2xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-40 h-40 bg-white/5 rounded-full blur-3xl transform translate-x-10 -translate-y-10" />
                        <div className="relative z-10">
                            <p className="text-white/60 text-sm">Velkommen tilbake</p>
                            <h2 className="text-3xl font-display mt-1">{user.name}</h2>
                            
                            <div className="grid grid-cols-3 gap-4 mt-6">
                                <div className="text-center">
                                    <p className="text-3xl font-semibold">{activeClients.length}</p>
                                    <p className="text-white/50 text-xs uppercase tracking-wide mt-1">Aktive</p>
                                </div>
                                <div className="text-center border-x border-white/10">
                                    <p className="text-3xl font-semibold">{archivedClients.length}</p>
                                    <p className="text-white/50 text-xs uppercase tracking-wide mt-1">Arkivert</p>
                                </div>
                                <div className="text-center">
                                    <p className="text-3xl font-semibold">{totalAthletes}</p>
                                    <p className="text-white/50 text-xs uppercase tracking-wide mt-1">Totalt</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Toggle og Ny-knapp */}
                    <div className="flex justify-between items-center">
                        <div className="flex gap-2">
                            <button 
                                onClick={showActive}
                                className={`px-3 py-1.5 text-sm font-medium rounded-lg transition-colors ${!showArchived ? 'bg-ink text-white' : 'text-ink-muted hover:bg-surface-100'}`}
                            >
                                Aktive ({activeClients.length})
                            </button>
                            <button 
                                onClick={showArchivedClients}
                                className={`px-3 py-1.5 text-sm font-medium rounded-lg transition-colors ${showArchived ? 'bg-ink text-white' : 'text-ink-muted hover:bg-surface-100'}`}
                            >
                                Arkivert ({archivedClients.length})
                            </button>
                        </div>
                        <Button variant="primary" size="sm" onClick={openModal}>
                            <Plus size={16} /> Ny
                        </Button>
                    </div>

                    {/* Client List */}
                    <div className="space-y-2">
                        {displayedClients.length === 0 ? (
                            <div className="text-center py-12 text-ink-muted">
                                <p className="font-display italic">{showArchived ? 'Ingen arkiverte utøvere' : 'Ingen aktive utøvere'}</p>
                                {!showArchived && <p className="text-sm mt-2">Trykk "Ny" for å legge til en utøver</p>}
                            </div>
                        ) : (
                            displayedClients.map(client => (
                                <Card 
                                    key={client.id} 
                                    className={`p-4 flex items-center justify-between group ${showArchived ? 'opacity-60' : ''}`}
                                    interactive
                                    onClick={() => onSelectClient(client)}
                                >
                                    <div className="flex items-center gap-4">
                                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center font-display text-xl ${showArchived ? 'bg-surface-200 text-ink-muted' : 'bg-surface-100 text-ink'}`}>
                                            {client.name.charAt(0)}
                                        </div>
                                        <div>
                                            <p className="font-medium">{client.name}</p>
                                            <p className="text-sm text-ink-muted">@{client.username}</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-1">
                                        {/* Arkiver/Gjenopprett knapp */}
                                        <button 
                                            onClick={(e) => { 
                                                e.stopPropagation(); 
                                                onArchiveClient(client.id, !client.is_archived); 
                                            }} 
                                            className="opacity-0 group-hover:opacity-100 transition-opacity p-2 text-ink-faint hover:text-ink"
                                            title={client.is_archived ? 'Gjenopprett' : 'Arkiver'}
                                        >
                                            {client.is_archived ? <Play size={18} /> : <Pause size={18} />}
                                        </button>
                                        {/* Slett knapp */}
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); if(confirm('Slett utøver permanent?')) onDeleteClient(client.id); }} 
                                            className="opacity-0 group-hover:opacity-100 transition-opacity p-2 text-ink-faint hover:text-red-500"
                                        >
                                            <Trash2 size={18} />
                                        </button>
                                        <ChevronRight size={18} className="text-ink-faint" />
                                    </div>
                                </Card>
                            ))
                        )}
                    </div>
                </div>
            );
        });

        // Initial data state - definert utenfor komponenten
        const INITIAL_DATA_STATE = { 
            dietPlan: '', workoutPlan: '', stepGoal: 10000, 
            totalWeeks: 12, startDate: null, isPaused: false, pausedAt: null, checkins: [] 
        };

        const App = () => {
            const [currentUser, setCurrentUser] = useState(null); 
            const [activeTab, setActiveTab] = useState('dashboard');
            const [allUsers, setAllUsers] = useState([]);
            const [viewingClient, setViewingClient] = useState(null);
            
            const [isClientLoading, setIsClientLoading] = useState(false);
            const [showWeightHistory, setShowWeightHistory] = useState(false);

            const [currentData, setCurrentData] = useState(INITIAL_DATA_STATE);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const init = async () => {
                    try {
                        const users = await api.getUsers();
                        setAllUsers(users);
                        const savedSession = localStorage.getItem('jnm_session');
                        if (savedSession) {
                            const sessionUser = JSON.parse(savedSession);
                            const isValidUser = users.find(u => u.id === sessionUser.id);
                            if (isValidUser) {
                                setCurrentUser(isValidUser);
                                if (isValidUser.role === 'athlete') setViewingClient(isValidUser);
                            } else {
                                localStorage.removeItem('jnm_session');
                            }
                        }
                    } catch(e) { console.error(e); } finally { setIsLoading(false); }
                };
                init();
            }, []);

            useEffect(() => {
                if (viewingClient) {
                    api.getUserData(viewingClient.id)
                        .then(setCurrentData)
                        .catch(() => setCurrentData(INITIAL_DATA_STATE))
                        .finally(() => setIsClientLoading(false));
                }
            }, [viewingClient]);

            const handleLogin = useCallback((user) => {
                setCurrentUser(user);
                localStorage.setItem('jnm_session', JSON.stringify(user));
                if (user.role === 'athlete') setViewingClient(user);
            }, []);

            const handleLogout = useCallback(() => {
                setCurrentUser(null);
                setViewingClient(null);
                localStorage.removeItem('jnm_session');
                setActiveTab('dashboard');
            }, []);

            const handleNewCheckin = useCallback(async (entry) => {
                if (!viewingClient) return;
                await api.submitCheckin(viewingClient.id, entry);
                setCurrentData(prev => ({ ...prev, checkins: [...prev.checkins, entry] }));
            }, [viewingClient]);
            
            const handleUpdateData = useCallback(async (keyOrObj, value) => {
                if (!viewingClient) return;
                let updates = typeof keyOrObj === 'string' ? { [keyOrObj]: value } : keyOrObj;
                setCurrentData(prev => {
                    const newData = { ...prev, ...updates };
                    api.saveUserData(viewingClient.id, newData).catch(() => {
                        alert('Lagring feilet');
                        setCurrentData(prev);
                    });
                    return newData;
                });
            }, [viewingClient]);

            const handleDeleteCheckin = useCallback(async (checkinId) => {
                if (!viewingClient) return;
                setCurrentData(prev => {
                    const previousCheckins = prev.checkins;
                    api.deleteCheckin(checkinId).catch(() => {
                        alert('Kunne ikke slette.');
                        setCurrentData(p => ({ ...p, checkins: previousCheckins }));
                    });
                    return { ...prev, checkins: prev.checkins.filter(c => c.id !== checkinId) };
                });
            }, [viewingClient]);

            const handleClearClient = useCallback(() => {
                setViewingClient(null);
                setActiveTab('dashboard');
            }, []);

            const handleSelectClient = useCallback((client) => {
                setCurrentData(INITIAL_DATA_STATE);
                setIsClientLoading(true);
                setViewingClient(client); 
                setShowWeightHistory(false); 
                setActiveTab('dashboard');
            }, []);

            const handleAddClient = useCallback(async (u) => {
                setAllUsers(await api.createUser({...u, id: Date.now().toString(), role:'athlete'}));
            }, []);

            const handleDeleteClient = useCallback(async (id) => {
                setAllUsers(await api.deleteUser(id));
            }, []);

            const handleArchiveClient = useCallback(async (id, archive) => {
                setAllUsers(await api.archiveUser(id, archive));
            }, []);

            const handleOpenWeightHistory = useCallback(() => setShowWeightHistory(true), []);
            const handleCloseWeightHistory = useCallback(() => setShowWeightHistory(false), []);

            const handleTabChange = useCallback((tab) => {
                setActiveTab(tab);
                setShowWeightHistory(false);
            }, []);

            if (isLoading) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-surface-50">
                        <Loader2 className="animate-spin text-ink-muted mb-4" size={32} />
                        <p className="text-ink-muted font-medium">Laster...</p>
                    </div>
                );
            }

            if (!currentUser) return <LoginScreen onLogin={handleLogin} />;
            
            const isCoach = currentUser.role === 'coach';
            const isArchived = currentUser.is_archived && !isCoach;

            // Arkivert bruker - begrenset tilgang
            if (isArchived) {
                return (
                    <div className="max-w-md mx-auto min-h-screen bg-surface-50">
                        <Header title="Konto pauset" user={currentUser} onLogout={handleLogout} />
                        <main className="p-4">
                            <div className="flex flex-col items-center justify-center min-h-[70vh] text-center px-6 animate-fade-in">
                                <div className="w-20 h-20 bg-surface-100 rounded-2xl flex items-center justify-center text-ink-muted mb-6">
                                    <Pause size={40} />
                                </div>
                                <h2 className="text-2xl font-display text-ink mb-3">Kontoen er pauset</h2>
                                <p className="text-ink-muted leading-relaxed mb-8">
                                    Din konto er for øyeblikket satt på pause av coachen din. 
                                    Du kan fortsatt se historikken din, men kan ikke sende inn nye rapporter.
                                </p>
                                
                                <div className="w-full space-y-3">
                                    <Button 
                                        variant="secondary" 
                                        size="lg" 
                                        className="w-full"
                                        onClick={() => setActiveTab('history')}
                                    >
                                        <Eye size={18} /> Se historikk
                                    </Button>
                                    <Button 
                                        variant="ghost" 
                                        size="lg" 
                                        className="w-full"
                                        onClick={handleLogout}
                                    >
                                        <LogOut size={18} /> Logg ut
                                    </Button>
                                </div>
                            </div>

                            {activeTab === 'history' && (
                                <div className="fixed inset-0 bg-surface-50 z-50 overflow-auto">
                                    <div className="sticky top-0 bg-surface-50/95 backdrop-blur-md border-b border-surface-200 px-4 py-4 flex items-center gap-3">
                                        <button onClick={() => setActiveTab('dashboard')} className="p-2 hover:bg-surface-100 rounded-xl">
                                            <ChevronLeft size={24} />
                                        </button>
                                        <h2 className="text-xl font-display">Din historikk</h2>
                                    </div>
                                    <div className="p-4 pb-8">
                                        <CheckInView 
                                            checkins={currentData.checkins} 
                                            onNewCheckin={() => {}} 
                                            onDelete={() => {}} 
                                            isReadOnly={true} 
                                            stepGoal={currentData.stepGoal}
                                            hideForm={true}
                                        />
                                    </div>
                                </div>
                            )}
                        </main>
                    </div>
                );
            }

            if (isCoach && !viewingClient) {
                return (
                    <div className="max-w-md mx-auto min-h-screen bg-surface-50">
                        <Header title="Oversikt" user={currentUser} onLogout={handleLogout} />
                        <main className="p-4">
                            <CoachDashboard 
                                user={currentUser} 
                                allUsers={allUsers} 
                                onSelectClient={handleSelectClient} 
                                onAddClient={handleAddClient} 
                                onDeleteClient={handleDeleteClient}
                                onArchiveClient={handleArchiveClient}
                            />
                        </main>
                    </div>
                );
            }

            const tabTitles = { dashboard: 'Hjem', gallery: 'Galleri', diet: 'Matplan', workout: 'Trening', checkin: 'Rapport' };
            const tabOrder = ['dashboard', 'gallery', 'diet', 'workout', 'checkin'];

            // Swipe mellom tabs
            const currentTabIndex = tabOrder.indexOf(activeTab);
            const handleSwipeLeft = useCallback(() => {
                if (currentTabIndex < tabOrder.length - 1 && !showWeightHistory) {
                    setActiveTab(tabOrder[currentTabIndex + 1]);
                    window.scrollTo({ top: 0, behavior: 'instant' });
                }
            }, [currentTabIndex, showWeightHistory]);
            
            const handleSwipeRight = useCallback(() => {
                if (currentTabIndex > 0 && !showWeightHistory) {
                    setActiveTab(tabOrder[currentTabIndex - 1]);
                    window.scrollTo({ top: 0, behavior: 'instant' });
                }
            }, [currentTabIndex, showWeightHistory]);

            const swipeHandlers = useSwipe(handleSwipeLeft, handleSwipeRight, { 
                threshold: 60, 
                enabled: !isClientLoading && !showWeightHistory 
            });

            // Pull to refresh
            const handleRefresh = useCallback(async () => {
                if (viewingClient) {
                    const freshData = await api.getUserData(viewingClient.id);
                    setCurrentData(freshData);
                }
            }, [viewingClient]);

            const { handlers: pullHandlers, pullIndicator } = usePullToRefresh(handleRefresh, { 
                enabled: !isClientLoading && !!viewingClient 
            });

            return (
                <div 
                    className="max-w-md mx-auto min-h-screen bg-surface-50"
                    {...swipeHandlers}
                    {...pullHandlers}
                >
                    {pullIndicator}
                    <Header 
                        title={tabTitles[activeTab]} 
                        user={currentUser} 
                        viewingClient={isCoach ? viewingClient : null} 
                        onLogout={handleLogout} 
                        onClearClient={handleClearClient} 
                    />
                    <main className="p-4">
                        {isClientLoading ? (
                            <div className="space-y-4 pt-4">
                                <Skeleton className="h-40 w-full" />
                                <div className="grid grid-cols-2 gap-4">
                                    <Skeleton className="h-32 w-full" />
                                    <Skeleton className="h-32 w-full" />
                                </div>
                            </div>
                        ) : (
                            <>
                                {activeTab === 'dashboard' ? (
                                    showWeightHistory ? (
                                        <WeightProgressView checkins={currentData.checkins} onBack={handleCloseWeightHistory} />
                                    ) : (
                                        <DashboardView userData={currentData} isCoach={isCoach} onUpdateData={handleUpdateData} onOpenWeightHistory={handleOpenWeightHistory} />
                                    )
                                ) :
                                activeTab === 'gallery' ? <GalleryView checkins={currentData.checkins} /> :
                                activeTab === 'diet' ? <PlanSection type="diet" content={currentData.dietPlan} onSave={(val) => handleUpdateData('dietPlan', val)} isReadOnly={!isCoach} /> :
                                activeTab === 'workout' ? <PlanSection type="workout" content={currentData.workoutPlan} onSave={(val) => handleUpdateData('workoutPlan', val)} isReadOnly={!isCoach} /> :
                                <CheckInView checkins={currentData.checkins} onNewCheckin={handleNewCheckin} onDelete={handleDeleteCheckin} isReadOnly={isCoach} stepGoal={currentData.stepGoal} />}
                            </>
                        )}
                    </main>
                    <Navigation activeTab={activeTab} setActiveTab={handleTabChange} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>